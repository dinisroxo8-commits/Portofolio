<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>IA Assistente â€” Tempo Real</title>
    <link rel="stylesheet" href="style.css">
    <style>
      /* pequenas correÃ§Ãµes locais */
      .chat-box { max-width: 980px; width:100%; margin: 12px auto; }
      .kb-item { margin-bottom:8px }
      .typing { font-style: italic; color: #aaa; margin:6px 0 }
      .user-msg { background: #3b3b5a; align-self: flex-end; margin:6px 0; padding:10px 14px; border-radius:10px; max-width:80%; }
      .bot-msg { background: #444466; align-self: flex-start; margin:6px 0; padding:10px 14px; border-radius:10px; max-width:80%; }
      .top-bar { display:flex; gap:8px; padding:8px 12px; background:#181827; color:#aaa; }
      input.api { flex:1; background:#1f1f2e; border:1px solid #3a3a5a; border-radius:5px; padding:6px; color:white; }
      .chat-content { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
      .chat-input { display:flex; padding:10px; gap:8px; background:#222238; border-top:1px solid #3a3a5a; }
      textarea { flex:1; resize:none; background:#1e1e2f; color:white; border:none; border-radius:5px; padding:10px; font-size:14px; }
      button.primary { padding:10px 15px; background:#5a5aff; color:white; border:none; border-radius:6px; cursor:pointer; }
      .file-chip { background:#3a3a5a; padding:6px 10px; border-radius:5px; font-size:13px; display:flex; gap:6px; align-items:center; }
      .file-chip span.remove { cursor:pointer; font-weight:bold; color:#ff5a5a; }
    </style>
  </head>
  <body>
    <div class="chat-box">
      <div class="top-bar">
        <input id="openaiKey" class="api" placeholder="Chave da OpenAI (opcional)" />
        <input id="weatherKey" class="api" placeholder="Chave do OpenWeatherMap (opcional)" />
        <select id="model" style="width:180px">
          <option>gpt-4o-mini</option>
          <option>gpt-4o</option>
          <option>gpt-3.5-turbo</option>
        </select>
      </div>

      <div id="chatContent" class="chat-content" role="log" aria-live="polite"></div>

      <div id="filePreview" style="padding:8px 12px; background:#1e1e2f; min-height:20px; display:none; flex-wrap:wrap; gap:8px;"></div>

      <div class="chat-input">
        <input type="file" id="fileInput" style="display:none" accept=".txt,.pdf,.jpg,.jpeg,.png,.gif" multiple />
        <button id="fileBtn" class="primary" style="background:#4a4aff" title="Anexar ficheiros">ðŸ“Ž</button>
        <textarea id="userInput" placeholder="Escreve aqui... (Enter envia, Shift+Enter nova linha)"></textarea>
        <button id="sendBtn" class="primary">Enviar</button>
      </div>

      <div style="padding:10px 12px; background:transparent">
        <div style="font-size:13px;color:#aaa">Comandos locais: <code>procura: termo</code>, <code>adicionar: TÃ­tulo | Texto</code>, <code>muda idioma: pt/en</code>, consultas de <code>tempo em cidade</code>, expressÃµes matemÃ¡ticas (ex: 2+2*3) e <code>hora</code>. Anexa ficheiros com ðŸ“Ž</div>
        <div id="kbList" class="kb-list" style="margin-top:8px"></div>
      </div>
    </div>

    <script>
      // Storage keys
      const LS_KEY = 'ia_assistente_v1';
      const LS_KB = 'ia_kb_v1';
      const LS_API = 'ia_openai_key';
      const LS_MODEL = 'ia_model';

      let state = { messages: [], language: 'pt', systemPrompt: 'Ã‰s um assistente Ãºtil que responde em PortuguÃªs.' };

      const defaultKB = [
        { id:1, title:'Instalar Node.js', text:'Vai a https://nodejs.org e instala a versÃ£o LTS.' },
        { id:2, title:'Usar Git', text:'git init -> git add . -> git commit -m "msg" -> git push' },
      ];

      // Elements
      const chat = document.getElementById('chatContent');
      const input = document.getElementById('userInput');
      const sendBtn = document.getElementById('sendBtn');
      const fileBtn = document.getElementById('fileBtn');
      const fileInput = document.getElementById('fileInput');
      const filePreview = document.getElementById('filePreview');
      const openaiKeyInput = document.getElementById('openaiKey');
      const weatherKeyInput = document.getElementById('weatherKey');
      const modelSel = document.getElementById('model');
      const kbList = document.getElementById('kbList');

      let attachedFiles = [];

      // Load / Save
      function loadState(){ try{ const r = localStorage.getItem(LS_KEY); if(r) state = Object.assign(state, JSON.parse(r)); }catch(e){} }
      function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      function loadKB(){ try{ const r = localStorage.getItem(LS_KB); return r ? JSON.parse(r) : defaultKB.slice(); }catch(e){ return defaultKB.slice(); } }
      function saveKB(kb){ localStorage.setItem(LS_KB, JSON.stringify(kb)); renderKB(); }
      function getAPIKey(){ return localStorage.getItem(LS_API) || ''; }
      function setAPIKey(v){ if(v) localStorage.setItem(LS_API, v); else localStorage.removeItem(LS_API); }

      // Rendering KB and messages
      function renderKB(){ const kb = loadKB(); kbList.innerHTML=''; kb.forEach(i=>{ const el=document.createElement('div'); el.className='kb-item'; el.innerHTML=`<strong>${i.title}</strong><div style="color:#aaa">${i.text}</div>`; kbList.appendChild(el); }); }

      function addMessage(text, who='bot'){
        const msg = document.createElement('div'); msg.className = who==='user' ? 'user-msg' : 'bot-msg';
        const meta = document.createElement('div'); meta.style.fontSize='12px'; meta.style.color='#9aa4b2'; meta.textContent = (who==='user' ? 'Tu' : 'Assistente') + ' â€¢ ' + new Date().toLocaleString();
        const body = document.createElement('div'); body.style.whiteSpace='pre-wrap'; body.textContent = text;
        msg.appendChild(meta); msg.appendChild(body); chat.appendChild(msg); chat.scrollTop = chat.scrollHeight;
        state.messages.push({who,text,ts:new Date().toISOString()}); saveState();
      }

      function showTyping(){ const el=document.createElement('div'); el.className='typing'; el.textContent='IA a escrever...'; chat.appendChild(el); chat.scrollTop = chat.scrollHeight; return el; }

      // KB search
      function kbSearch(q){ q=q.toLowerCase(); const kb = loadKB(); return kb.filter(x => x.title.toLowerCase().includes(q) || x.text.toLowerCase().includes(q)); }

      function localResponder(msg){
        const q = msg.trim(); const lq = q.toLowerCase();
        if(/^ajuda$|^help$/i.test(lq)) return `Comandos:\n- ajuda\n- procura: termo\n- adicionar: TÃ­tulo | Texto\n- muda idioma: pt/en\n- tempo em CIDADE\n- expressÃµes matemÃ¡ticas\n- Anexar ficheiros com ðŸ“Ž`;
        if(lq.startsWith('procura:')){ const term=q.split(':').slice(1).join(':').trim(); if(!term) return 'Diz o que procurar depois de "procura:".'; const hits=kbSearch(term); if(!hits.length) return 'Nenhum resultado na KB local.'; return hits.map(h=>`${h.title}\n${h.text}`).join('\n\n'); }
        if(lq.startsWith('adicionar:')){ const rest=q.split(':').slice(1).join(':').trim(); const parts=rest.split('|').map(s=>s.trim()); if(parts.length<2) return 'Usa: adicionar: TÃ­tulo | Texto'; const [title,text]=parts; const kb=loadKB(); const id=kb.length?Math.max(...kb.map(x=>x.id))+1:1; kb.push({id,title,text}); saveKB(kb); return `Adicionado Ã  KB (id ${id}): ${title}`; }
        if(lq.startsWith('muda idioma:')){ const lang=q.split(':').slice(1).join(':').trim().toLowerCase(); if(['pt','pt-pt'].includes(lang)){ state.language='pt'; state.systemPrompt='Ã‰s um assistente Ãºtil que responde em PortuguÃªs.'; saveState(); return 'Idioma alterado para PortuguÃªs.' } if(['en','en-us','en-uk'].includes(lang)){ state.language='en'; state.systemPrompt='You are a helpful assistant that replies in English.'; saveState(); return 'Language changed to English.' } return 'Idioma desconhecido. Usa pt ou en.' }
        const hits = kbSearch(q); if(hits.length) return `Encontrei na KB: ${hits[0].title}\n${hits[0].text}`;
        return state.language==='pt' ? 'Modo offline: nÃ£o sei responder bem a isso. Insere a OpenAI API key para respostas avanÃ§adas.' : 'Offline mode: provide an OpenAI API key for advanced answers.';
      }

      // Weather
      async function getWeather(cidade, key){ try{ const url=`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(cidade)}&appid=${key}&lang=pt&units=metric`; const r=await fetch(url); const j=await r.json(); if(j.cod && +j.cod!==200) return null; return `Em ${j.name}: ${j.weather[0].description}, ${j.main.temp}Â°C (sensaÃ§Ã£o ${j.main.feels_like}Â°C).`; }catch(e){return null} }

      // Safe math evaluator
      function evalMath(expr){ const safe = expr.replace(/\^/g,'**').replace(/[^0-9+\-*/().%\s\*\*]/g,''); if(!/^[0-9+\-*/().%\s\*\*]+$/.test(safe)) return null; try{ const fn = new Function('return ' + safe); const res = fn(); return String(res); }catch(e){ return null } }

      // File handling
      function renderFilePreview(){ 
        if(!attachedFiles.length){ 
          filePreview.style.display='none'; 
          return; 
        } 
        filePreview.style.display='flex'; 
        filePreview.innerHTML=''; 
        attachedFiles.forEach((f,i)=>{ 
          const chip=document.createElement('div'); 
          chip.className='file-chip';
          chip.innerHTML=`<span>ðŸ“„ ${f.name}</span><span class="remove" data-idx="${i}">Ã—</span>`; 
          filePreview.appendChild(chip); 
        }); 
        filePreview.querySelectorAll('.remove').forEach(el=>{ 
          el.addEventListener('click',()=>{ 
            attachedFiles.splice(+el.dataset.idx,1); 
            renderFilePreview(); 
          }); 
        }); 
      }

      async function readFileAsBase64(file){ 
        return new Promise((res,rej)=>{ 
          const r=new FileReader(); 
          r.onload=()=>res(r.result.split(',')[1]); 
          r.onerror=rej; 
          r.readAsDataURL(file); 
        }); 
      }
      
      async function readFileAsText(file){ 
        return new Promise((res,rej)=>{ 
          const r=new FileReader(); 
          r.onload=()=>res(r.result); 
          r.onerror=rej; 
          r.readAsText(file); 
        }); 
      }

      async function processFiles(){ 
        const processed=[]; 
        for(const file of attachedFiles){ 
          const type=file.type; 
          const name=file.name; 
          if(type.startsWith('image/')){ 
            const b64=await readFileAsBase64(file); 
            processed.push({type:'image',name,data:b64,mimeType:type}); 
          } else if(type==='application/pdf'){ 
            const b64=await readFileAsBase64(file); 
            processed.push({type:'pdf',name,data:b64}); 
          } else { 
            const txt=await readFileAsText(file); 
            processed.push({type:'text',name,data:txt}); 
          } 
        } 
        return processed; 
      }

      // OpenAI call with file support
      async function askOpenAI(apiKey, model, messages, files=[]){ 
        const userContent = [];
        const lastMsg = messages[messages.length-1];
        if(lastMsg.content) userContent.push({type:'text',text:lastMsg.content});
        
        for(const f of files){
          if(f.type==='image'){ 
            userContent.push({type:'image_url',image_url:{url:`data:${f.mimeType};base64,${f.data}`}}); 
          }
          else if(f.type==='text'){ 
            userContent.push({type:'text',text:`\n\n[ConteÃºdo do ficheiro "${f.name}"]:\n${f.data}`}); 
          }
          else if(f.type==='pdf'){ 
            userContent.push({type:'text',text:`\n\n[Ficheiro PDF "${f.name}" anexado - processamento limitado em base64]`}); 
          }
        }
        
        const finalMessages = [...messages.slice(0,-1), {role:'user',content:userContent.length>1?userContent:lastMsg.content}];
        const payload={model,messages:finalMessages,max_tokens:1200,temperature:0.7}; 
        const resp=await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+apiKey
          },
          body:JSON.stringify(payload)
        }); 
        if(!resp.ok){ 
          const txt=await resp.text(); 
          throw new Error(txt||resp.status); 
        } 
        const data=await resp.json(); 
        return data.choices?.[0]?.message?.content || ''; 
      }

      // Main send
      let busy=false;
      async function onSend(){ 
        if(busy) return; 
        const text = input.value.trim(); 
        if(!text && !attachedFiles.length) return; 
        
        const userMsg = text || '(ficheiro anexado)';
        input.value=''; 
        const files = await processFiles();
        attachedFiles = [];
        renderFilePreview();
        
        addMessage(userMsg + (files.length ? ` ðŸ“Ž [${files.length} ficheiro(s)]` : ''),'user');
        
        const weatherMatch = text.match(/tempo (?:em|no|na)?\s*([a-zA-ZÃ€-Ã¿\-\s]+)/i);
        const mathMatch = text.match(/^\s*([0-9().+\-*/%^\s]+)\s*$/);
        const horaMatch = /\bhora\b|que horas|hora Ã©/i.test(text);

        if(weatherMatch && weatherKeyInput.value.trim() && !files.length){ 
          busy=true; 
          const t=showTyping(); 
          const cidade = weatherMatch[1].trim(); 
          const w = await getWeather(cidade, weatherKeyInput.value.trim()); 
          t.remove(); 
          busy=false; 
          if(w){ addMessage(w,'bot'); return } 
        }
        if(mathMatch && !files.length){ 
          const out = evalMath(mathMatch[1]); 
          if(out!==null){ addMessage('Resposta: ' + out,'bot'); return } 
        }
        if(horaMatch && !files.length){ 
          const now=new Date(); 
          addMessage('Agora: ' + now.toLocaleString(),'bot'); 
          return; 
        }
        if(/^(procura:|adicionar:|muda idioma:|ajuda$|help$)/i.test(text) && !files.length){ 
          const r = localResponder(text); 
          addMessage(r,'bot'); 
          return; 
        }

        const apiKey = openaiKeyInput.value.trim() || getAPIKey();
        if(apiKey){ 
          busy=true; 
          const t=showTyping(); 
          try{ 
            const messages=[
              {role:'system',content:state.systemPrompt}, 
              ...state.messages.slice(-10).map(m=>({role:m.who==='user'?'user':'assistant',content:m.text})), 
              {role:'user',content:text||'Analisa este(s) ficheiro(s)'}
            ]; 
            const reply = await askOpenAI(apiKey, modelSel.value||'gpt-4o-mini', messages, files); 
            t.remove(); 
            busy=false; 
            addMessage(reply||'(sem resposta)','bot'); 
          }catch(err){ 
            t.remove(); 
            busy=false; 
            console.error(err); 
            addMessage('Erro OpenAI: '+String(err),'bot'); 
            if(!files.length){ 
              const fallback = localResponder(text); 
              addMessage(fallback,'bot'); 
            } 
          } 
        }
        else { 
          if(files.length){ 
            addMessage('Para processar ficheiros, insere a OpenAI API key no topo.','bot'); 
          } else { 
            const r = localResponder(text); 
            addMessage(r,'bot'); 
          } 
        }
      }

      // Init
      loadState(); 
      renderKB(); 
      openaiKeyInput.value = getAPIKey(); 
      modelSel.value = localStorage.getItem(LS_MODEL) || 'gpt-4o-mini';
      
      sendBtn.addEventListener('click', onSend);
      fileBtn.addEventListener('click', ()=>fileInput.click());
      fileInput.addEventListener('change', (e)=>{ 
        attachedFiles.push(...Array.from(e.target.files)); 
        renderFilePreview(); 
        e.target.value=''; 
      });
      input.addEventListener('keydown', (e)=>{ 
        if(e.key==='Enter' && !e.shiftKey){ 
          e.preventDefault(); 
          onSend(); 
        } 
      });
      openaiKeyInput.addEventListener('change', ()=>{ 
        setAPIKey(openaiKeyInput.value.trim()); 
      });
      modelSel.addEventListener('change', ()=>{ 
        localStorage.setItem(LS_MODEL, modelSel.value); 
      });

      // greeting
      addMessage(state.language==='pt' ? 'OlÃ¡ â€” sou a tua IA local. Podes pedir tempo, matemÃ¡tica, hora, KB ou inserir a OpenAI API key para respostas avanÃ§adas. Usa ðŸ“Ž para anexar ficheiros!' : 'Hello â€” I am your local AI. Provide an OpenAI API key for advanced answers. Use ðŸ“Ž to attach files!');
    </script>
  </body>
</html>
